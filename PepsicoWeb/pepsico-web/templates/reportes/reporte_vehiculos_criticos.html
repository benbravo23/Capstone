{% extends 'base.html' %}

{% block title %}Vehículos Críticos - PepsiCo{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="display-5">
                <i class="bi bi-exclamation-triangle text-danger"></i> Vehículos Críticos
            </h1>
            <p class="text-muted">Vehículos con más mantenimientos y análisis de criticidad</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{% url 'reportes_dashboard' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="card card-pepsi mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-5">
                    <label class="form-label">Desde</label>
                    <input type="date" name="fecha_desde" class="form-control" value="{{ fecha_desde }}">
                </div>
                <div class="col-md-5">
                    <label class="form-label">Hasta</label>
                    <input type="date" name="fecha_hasta" class="form-control" value="{{ fecha_hasta }}">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-pepsi-primary w-100">
                        <i class="bi bi-funnel"></i> Filtrar
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Leyenda de criticidad -->
    <div class="alert alert-info mb-4">
        <h6 class="mb-2"><i class="bi bi-info-circle"></i> Niveles de Criticidad:</h6>
        <span class="badge bg-danger me-2">ALTA</span> Más de 5 ingresos en el período
        <span class="badge bg-warning text-dark ms-3 me-2">MEDIA</span> Entre 3 y 5 ingresos
        <span class="badge bg-success ms-3 me-2">BAJA</span> Menos de 3 ingresos
    </div>
    
    <!-- Tabla de vehículos -->
    <div class="card card-pepsi">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-table"></i> Análisis de Vehículos ({{ vehiculos_data|length }} vehículos)</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Patente</th>
                            <th>Vehículo</th>
                            <th>Tipo</th>
                            <th>Ingresos</th>
                            <th>Total Tareas</th>
                            <th>Tiempo Promedio (min)</th>
                            <th>Criticidad</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in vehiculos_data %}
                        <tr>
                            <td><strong>{{ forloop.counter }}</strong></td>
                            <td><strong>{{ item.vehiculo.patente }}</strong></td>
                            <td>{{ item.vehiculo.marca }} {{ item.vehiculo.modelo }}</td>
                            <td>
                                <span class="badge bg-secondary">{{ item.vehiculo.get_tipo_display }}</span>
                            </td>
                            <td>
                                <span class="badge bg-primary fs-6">{{ item.num_ingresos }}</span>
                            </td>
                            <td>{{ item.total_tareas }}</td>
                            <td>{{ item.tiempo_promedio_formateado }}</td>
                            <td>
                                {% if item.criticidad == 'ALTA' %}
                                <span class="badge bg-danger">
                                    <i class="bi bi-exclamation-triangle-fill"></i> ALTA
                                </span>
                                {% elif item.criticidad == 'MEDIA' %}
                                <span class="badge bg-warning text-dark">
                                    <i class="bi bi-exclamation-circle-fill"></i> MEDIA
                                </span>
                                {% else %}
                                <span class="badge bg-success">
                                    <i class="bi bi-check-circle-fill"></i> BAJA
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{% url 'vehiculo_detail' item.vehiculo.pk %}" 
                                   class="btn btn-sm btn-outline-primary"
                                   title="Ver detalles del vehículo">
                                    <i class="bi bi-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center text-muted py-4">
                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                No hay vehículos con ingresos en el período seleccionado
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Gráfico de criticidad -->
    {% if vehiculos_data %}
    <div class="row g-4 mt-4">
        <div class="col-md-6">
            <div class="card card-pepsi">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Distribución por Criticidad</h5>
                </div>
                <div class="card-body">
                    <canvas id="chartCriticidad"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card card-pepsi">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Top 10 Vehículos por Ingresos</h5>
                </div>
                <div class="card-body">
                    <canvas id="chartTopVehiculos"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
{% if vehiculos_data %}
// Calcular distribución de criticidad
let alta = 0, media = 0, baja = 0;
{% for item in vehiculos_data %}
    {% if item.criticidad == 'ALTA' %}
        alta++;
    {% elif item.criticidad == 'MEDIA' %}
        media++;
    {% else %}
        baja++;
    {% endif %}
{% endfor %}

// Gráfico de criticidad
const ctxCriticidad = document.getElementById('chartCriticidad').getContext('2d');
new Chart(ctxCriticidad, {
    type: 'doughnut',
    data: {
        labels: ['Alta', 'Media', 'Baja'],
        datasets: [{
            data: [alta, media, baja],
            backgroundColor: ['#dc3545', '#ffc107', '#198754']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Gráfico de top vehículos
const ctxTopVehiculos = document.getElementById('chartTopVehiculos').getContext('2d');
new Chart(ctxTopVehiculos, {
    type: 'bar',
    data: {
        labels: [{% for item in vehiculos_data|slice:":10" %}'{{ item.vehiculo.patente }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: 'Número de Ingresos',
            data: [{% for item in vehiculos_data|slice:":10" %}{{ item.num_ingresos }}{% if not forloop.last %},{% endif %}{% endfor %}],
            backgroundColor: '#004B93',
            borderColor: '#003366',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}