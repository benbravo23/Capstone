{% extends "base.html" %}
{% load static %}

{% block title %}Mis Tareas - PepsiCo{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-0">
                <i class="bi bi-list-check"></i> Mis Tareas
            </h1>
            <p class="text-muted small mt-1">Tareas asignadas a {{ user.nombre }}</p>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card-pepsi text-center">
                <h4 class="text-primary">{{ stats.total }}</h4>
                <p class="small text-muted mb-0">Total de Tareas</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card-pepsi text-center">
                <h4 class="text-warning">{{ stats.pendientes }}</h4>
                <p class="small text-muted mb-0">Pendientes</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card-pepsi text-center">
                <h4 class="text-info">{{ stats.en_proceso }}</h4>
                <p class="small text-muted mb-0">En Proceso</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card-pepsi text-center">
                <h4 class="text-success">{{ stats.completadas }}</h4>
                <p class="small text-muted mb-0">Completadas</p>
            </div>
        </div>
    </div>

    <!-- Filtro por Estado -->
    <div class="row mb-3">
        <div class="col-12">
            <form method="get" class="d-flex gap-2" style="flex-wrap: wrap;">
                <a href="{% url 'mecanico_tareas' %}" class="btn btn-sm {% if not estado_filter %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    Todas ({{ stats.total }})
                </a>
                <a href="?estado=PENDIENTE" class="btn btn-sm {% if estado_filter == 'PENDIENTE' %}btn-warning{% else %}btn-outline-warning{% endif %}">
                    Pendientes ({{ stats.pendientes }})
                </a>
                <a href="?estado=EN_PROCESO" class="btn btn-sm {% if estado_filter == 'EN_PROCESO' %}btn-info{% else %}btn-outline-info{% endif %}">
                    En Proceso ({{ stats.en_proceso }})
                </a>
                <a href="?estado=COMPLETADA" class="btn btn-sm {% if estado_filter == 'COMPLETADA' %}btn-success{% else %}btn-outline-success{% endif %}">
                    Completadas ({{ stats.completadas }})
                </a>
            </form>
        </div>
    </div>

    <!-- Lista de Tareas -->
    {% if tareas %}
    <div class="row">
        {% for tarea in tareas %}
        <div class="col-md-6 col-lg-4 mb-3">
            <a href="{% url 'tarea_detail' tarea.pk %}" class="text-decoration-none">
            <div class="card-pepsi h-100" style="border-left: 4px solid 
                {% if tarea.estado == 'PENDIENTE' %}#ffc107
                {% elif tarea.estado == 'EN_PROCESO' %}#17a2b8
                {% elif tarea.estado == 'PAUSADA' %}#fd7e14
                {% elif tarea.estado == 'COMPLETADA' %}#28a745
                {% else %}#6c757d
                {% endif %}; cursor: pointer;" role="button">
                
                <!-- Header de la tarea -->
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h5 class="card-title mb-1">{{ tarea.titulo }}</h5>
                        <p class="text-muted small mb-0">
                            {% if tarea.prioridad %}
                            <span class="badge 
                                {% if tarea.prioridad == 'URGENTE' %}bg-danger
                                {% elif tarea.prioridad == 'ALTA' %}bg-warning
                                {% elif tarea.prioridad == 'MEDIA' %}bg-info
                                {% else %}bg-secondary
                                {% endif %}">
                                {{ tarea.get_prioridad_display }}
                            </span>
                            {% endif %}
                        </p>
                    </div>
                    <span class="badge 
                        {% if tarea.estado == 'PENDIENTE' %}bg-warning
                        {% elif tarea.estado == 'EN_PROCESO' %}bg-info
                        {% elif tarea.estado == 'COMPLETADA' %}bg-success
                        {% else %}bg-secondary
                        {% endif %}">
                        {{ tarea.get_estado_display }}
                    </span>
                </div>

                <!-- Detalles del Vehículo -->
                {% if tarea.ingreso.vehiculo %}
                <div class="section-card mb-3" style="background-color: #e7f3ff; border-left: 3px solid #0056b3;">
                    <div class="mb-2">
                        <p class="small text-muted mb-1">Vehículo:</p>
                        <h6 class="mb-1">
                            <i class="bi bi-truck text-primary"></i>
                            <strong>{{ tarea.ingreso.vehiculo.patente }}</strong>
                        </h6>
                        <p class="small mb-1">
                            <strong>Marca/Modelo:</strong> {{ tarea.ingreso.vehiculo.marca }} {{ tarea.ingreso.vehiculo.modelo }}
                        </p>
                        {% if tarea.ingreso.vehiculo.año %}
                        <p class="small mb-1">
                            <strong>Año:</strong> {{ tarea.ingreso.vehiculo.año }}
                        </p>
                        {% endif %}
                        {% if tarea.ingreso.vehiculo.numero_serie %}
                        <p class="small mb-0">
                            <strong>Serie:</strong> {{ tarea.ingreso.vehiculo.numero_serie }}
                        </p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Descripción -->
                {% if tarea.descripcion %}
                <div class="mb-3">
                    <p class="small text-muted mb-1">Descripción:</p>
                    <p class="small mb-0">{{ tarea.descripcion|linebreaks }}</p>
                </div>
                {% endif %}

                <!-- Tiempos -->
                <div class="row g-2 mb-3">
                    {% if tarea.tiempo_estimado_minutos %}
                    <div class="col-6">
                        <small class="text-muted d-block">Tiempo Est.</small>
                        <strong>{{ tarea.tiempo_estimado_minutos }} min</strong>
                    </div>
                    {% endif %}
                    <div class="col-6">
                        <small class="text-muted d-block">
                            {% if tarea.estado == 'COMPLETADA' %}
                            Tiempo Invertido
                            {% else %}
                            Tiempo Transcurrido
                            {% endif %}
                        </small>
                        <strong>
                            {% if tarea.estado == 'COMPLETADA' %}
                            {{ tarea.tiempo_invertido_minutos }} min
                            {% elif tarea.fecha_inicio %}
                            {{ tarea.tiempo_transcurrido_minutos }} min
                            {% else %}
                            -
                            {% endif %}
                        </strong>
                    </div>
                </div>

                <!-- Progreso de tiempo (si hay estimado) -->
                {% if tarea.tiempo_estimado_minutos %}
                <div class="progress mb-3" style="height: 20px;">
                    <div class="progress-bar 
                        {% if tarea.porcentaje_tiempo <= 80 %}bg-success
                        {% elif tarea.porcentaje_tiempo <= 100 %}bg-warning
                        {% else %}bg-danger
                        {% endif %}" 
                         role="progressbar" 
                         style="width: {{ tarea.porcentaje_tiempo|default:0 }}%"
                         aria-valuenow="{{ tarea.porcentaje_tiempo|default:0 }}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        {{ tarea.porcentaje_tiempo|default:0 }}%
                    </div>
                </div>
                {% endif %}

                <!-- Repuestos utilizados -->
                {% if tarea.repuestos_utilizados %}
                <div class="mb-3">
                    <p class="small text-muted mb-1">Repuestos Utilizados:</p>
                    <p class="small mb-0">{{ tarea.repuestos_utilizados }}</p>
                </div>
                {% endif %}

                <!-- Observaciones -->
                {% if tarea.observaciones %}
                <div class="mb-3">
                    <p class="small text-muted mb-1">Observaciones:</p>
                    <p class="small mb-0">{{ tarea.observaciones }}</p>
                </div>
                {% endif %}

                <!-- Fechas -->
                <div class="border-top pt-2 mt-3 mb-3">
                    <small class="text-muted d-block">
                        <i class="bi bi-calendar"></i>
                        Asignada: {{ tarea.fecha_asignacion|date:"d/m/Y H:i" }}
                    </small>
                    {% if tarea.fecha_inicio %}
                    <small class="text-info d-block">
                        <i class="bi bi-play-circle"></i>
                        Iniciada: {{ tarea.fecha_inicio|date:"d/m/Y H:i" }}
                    </small>
                    {% endif %}
                    {% if tarea.fecha_completada %}
                    <small class="text-success d-block">
                        <i class="bi bi-check-circle"></i>
                        Completada: {{ tarea.fecha_completada|date:"d/m/Y H:i" }}
                    </small>
                    {% endif %}
                </div>

                <!-- Acciones Rápidas -->
                <div class="d-grid gap-2">
                    {% if tarea.estado == 'PENDIENTE' %}
                    <a href="{% url 'tarea_iniciar' tarea.pk %}" class="btn btn-sm btn-success">
                        <i class="bi bi-play-fill"></i> Iniciar Tarea
                    </a>
                    {% elif tarea.estado == 'EN_PROCESO' %}
                    <div class="btn-group btn-group-sm d-grid gap-2" role="group">
                        <a href="{% url 'tarea_pausar' tarea.pk %}" class="btn btn-warning">
                            <i class="bi bi-pause-fill"></i> Pausar
                        </a>
                        <a href="{% url 'tarea_completar' tarea.pk %}" class="btn btn-success">
                            <i class="bi bi-check-lg"></i> Completar
                        </a>
                    </div>
                    {% elif tarea.estado == 'PAUSADA' %}
                    <div class="btn-group btn-group-sm d-grid gap-2" role="group">
                        <a href="{% url 'tarea_reanudar' tarea.pk %}" class="btn btn-info">
                            <i class="bi bi-play-fill"></i> Reanudar
                        </a>
                        <a href="{% url 'tarea_completar' tarea.pk %}" class="btn btn-success">
                            <i class="bi bi-check-lg"></i> Completar
                        </a>
                    </div>
                    {% elif tarea.estado == 'COMPLETADA' %}
                    <span class="btn btn-sm btn-success disabled">
                        <i class="bi bi-check-circle"></i> Completada
                    </span>
                    {% else %}
                    <a href="{% url 'tarea_detail' tarea.pk %}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-eye"></i> Ver Detalle
                    </a>
                    {% endif %}
                </div>

            </div>
            </a>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Sin tareas -->
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info text-center py-5">
                <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.5;"></i>
                <p class="mt-3 mb-0">
                    {% if estado_filter %}
                        No tienes tareas {{ estado_filter|lower }}.
                    {% else %}
                        ¡No tienes tareas asignadas en este momento!
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
    .card-pepsi {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        border: 1px solid #e0e0e0;
    }

    .card-pepsi:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .section-card {
        background-color: #f4f7fb;
        border-radius: 8px;
        padding: 1rem;
        border-left: 3px solid #0056b3;
    }
</style>
{% endblock %}
